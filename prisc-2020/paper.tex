%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[sigplan]{acmart}\settopmatter{}


%% Conference information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmConference[PL'18]{ACM SIGPLAN Conference on Programming Languages}{January 01--03, 2018}{New York, NY, USA}
\acmYear{2018}
\acmISBN{} % \acmISBN{978-x-xxxx-xxxx-x/YY/MM}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%\citestyle{acmauthoryear}  %% For author/year citations
%\citestyle{acmnumeric}     %% For numeric citations
%\setcitestyle{nosort}      %% With 'acmnumeric', to disable automatic
                            %% sorting of references within a single citation;
                            %% e.g., \cite{Smith99,Carpenter05,Baker12}
                            %% rendered as [14,5,2] rather than [2,5,14].
%\setcitesyle{nocompress}   %% With 'acmnumeric', to disable automatic
                            %% compression of sequential references within a
                            %% single citation;
                            %% e.g., \cite{Baker12,Baker14,Baker16}
                            %% rendered as [2,3,4] rather than [2-4].


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from traditional SIGPLAN
%% proceedings format to PACMPL format must update the
%% '\documentclass' and topmatter commands above; see
%% 'acmart-pacmpl-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
%\usepackage[showframe]{geometry}% http://ctan.org/pkg/geometry
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{tikz}
\usetikzlibrary{decorations.pathreplacing}
\usepackage{xcolor}
\usepackage{graphicx} % need this package
\usepackage{stmaryrd}
\usepackage{amsthm}
\usepackage{dsfont}
\usepackage{float}
\usepackage{IEEEtrantools}

\newcommand{\sep}{-\kern-.6em\raisebox{-.659ex}{*}\ }
\newcommand{\bupd}[1]{=\kern-.6em\{#1\}\ \kern-.9em =\ \kern-.8em\raisebox{-.659ex}{*}\ }

\newcommand{\bigsep}{\mathop{\scalebox{2.5}{\raisebox{-0.4ex}{$*$}}}}%

\newcommand{\ra}[1] {
  \begin{tikzpicture}
        \node[draw,dashed] {#1};
    \end{tikzpicture}}
    
\newcommand{\inv}[1] {
  \begin{tikzpicture}
        \node[draw] {#1};
    \end{tikzpicture}}
    
\newcommand{\interp}[2]{(#1)(#2)}
\newcommand\sepimp{\mathrel{-\mkern-6mu*}}

\usetikzlibrary{decorations.pathreplacing}

\newcommand\MemoryLayout[1]{
  \begin{tikzpicture}[scale=0.3]
     \draw[thick](0,0)--++(0,1);
     \foreach \pt/\col/\lab [remember=\pt as \tp (initially 0)] in {#1} {
     \if\lab\relax\relax\else
         \draw[thick,decorate, decoration={brace,amplitude=4mm}]
            (-\tp,-0.2)--node[below=4mm]{\lab} (-\pt+2,-0.2);
            \draw[fill=\col] (-\tp,0) rectangle (-\pt+2,1);
       \fi
       \foreach \a in {\tp,...,\pt} {
          \draw(-\a,0) rectangle ++(-1,1);
       }
       \draw[thick](-\pt,0)--++(0,1);
       
     }
     \node at (-4.5,0.6) {\small B};
  \end{tikzpicture}
}

\begin{document}

%% Title information
\title[Short Title]{Mechanized Reasoning about a Capability Machine}
%% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{A{\"i}na Linn Georges}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  %\position{Position1}
  %\department{Department1}              %% \department is recommended
  \institution{Aarhus University}            %% \institution is required
  %\streetaddress{Street1 Address1}
  %\city{City1}
  %\state{State1}
  %\postcode{Post-Code1}
  %\country{Denmark}                    %% \country is recommended
}
\email{ageorges@cs.au.dk}          %% \email is recommended


\author{Lars Birkedal}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  %\position{Position2a}
  %\department{Department2a}             %% \department is recommended
  \institution{Aarhus University}           %% \institution is required
  %\streetaddress{Street2a Address2a}
  %\city{City2a}
  %\state{State2a}
  %\postcode{Post-Code2a}
  %\country{Denmark}                   %% \country is recommended
}
\email{birkedal@cs.au.dk}         %% \email is recommended



%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}

Part of showing full abstraction consists of showing that the expressive power of a compiled program, is exactly the expressive power as the source program. This becomes a challenge when the expressive power of the target language is bigger than the expressive power of the source language. 

Take for instance the compilation from a high level functional language, to a low level machine language. Certain high level abstractions are taken for granted by the high level language, such as local state encapsulation and well bracketed control flow. At the lowest level, a machine may allow arbitrary jumps to instructions in memory, and arbitrarily manipulate pointers to access any local state otherwise hidden by the top level abstraction. It must therefore be up to the compiler to enforce such abstractions, if we want to show secure compilation. 

Capability Machines allow for fine grained control over the \textit{authority} of memory. At the machine level, pointers are replaced by capabilities, to which is attached a range of authority and a permission. The language then executes instructions by dynamically checking that the instruction uses a capability within its range of authority. Using a capability machine language as the target of a secure compiler allows us to take advantage these dynamic checks to enforce the high level abstractions mentioned above. 

In \cite{skorstengaardESOP18} and \cite{SkorstengaardPOPL19}, Skorstensgaard et. al. present two different calling conventions that enforce well bracketed control flow, and methods for defining and reasoning about capability machines. In each case, they define a step indexed Kripke Logical Relation to define a notion of capability safety. However, such logical relations are notoriously difficult to reason about \cite{Ahmed2004SemanticsOT}. A formalization of these definitions into a proof assistant could facilitate such reasoning, and enable easier exploration of extensions and variations to the language.

Iris is a higher-order concurrent separation logic framework. Its support of higher-order ghost state makes Iris a great candidate for complex reasoning about \textit{state}. This is exactly what we need for reasoning about a machine, where computation consist of state manipulation. Furthermore, the model of Iris is itself step-indexed, and comes equipped with a later modality: $\triangleright$. The later modality enables elegant Iris definitions of step-indexed logical relations \cite{Krebbers:2017} \cite{Timany:2017}. 

The work in process formalization will make the following contributions: 
\begin{itemize}
	\item A formalization of a capability machine program logic in Iris, in which programs lie in memory, and execution is completely statefull. 
	\item An Iris formalization of a Logical Relation to reason about programs in a capability machine language, which can be used to reason about local state while distinguishing between well-bracketed, and non well-bracketed calls.
\end{itemize} 


\section{Iris Embedding of a Capability Machine}
The first step of formalizing the logical relation, is to embed the capability machine language into Iris. We want a formalization which can be used to show full abstraction from a high level language, to a low level capability machine. We are interested in the case where the target language does not natively enforce certain basic abstractions of a high level language: local state encapsulation of well bracketed control flow. With this goal in mind, it is important not to \textit{accidentally} formalize a language where certain control flow abstractions are still enforced, such as implementing the language using frames and labels. Rather, we are interested in reasoning about a language with arbitrary jumps, and (almost) arbitrary capability manipulations (within its given range of authority). 

Machine instructions operate through memory. Typically a machine will have a special register; the program counter, which contains a pointer to an address in memory. That address in turn will contain an integer, which can then be decoded to various machine dependent instructions, such as Load, Store, Jump, etc. Once an instruction has been executed, the program counter is incremented and will now point to the next instruction in memory. A jump now simply consist of a store into the program counter itself. Strictly speaking, such a language does have expressions, rather it executes given the configurations: the state of registers and the state of memory. 

\section{Logical Relation}
\begin{figure*}[ht]
	\begin{minipage}{\textwidth}
	\begin{align*}
		\mathcal{E}\interp{W}{pc} \triangleq&~\forall r, \mathcal{R}(W)(r) ~*~\textsf{context}(W)(r[\textsf{\small PC}:=pc])\\
		&\sep~\textsc{WP}~\textsf{Seq (Instr Executable)}~\{ v, v = HaltedV \implies \exists W' r', W' \sqsubseteq_{priv} W * \textsf{context}(W')(r')\}
	\end{align*}
	\end{minipage}
	\label{fig:expr}
	\caption{Logical Relation for Expressions}
\end{figure*}

\begin{figure*}[ht]
	\begin{minipage}{\textwidth}
	\begin{align*}
		\mathcal{R}\interp{W}{r} \triangleq&~\forall (reg : \text{RegName} \backslash \textsf{PC}), \mathcal{V}\interp{W}{r(reg)}
	\end{align*}
	\end{minipage}
	\label{fig:expr}
	\caption{Logical Relation for Register States}
\end{figure*}

\begin{figure*}[ht]
	\begin{minipage}{\textwidth}
	\begin{align*}
 		\mathcal{V}\interp{W}{z} \triangleq&~\exists z' \in \mathds{Z}. z = z' \\
 		\mathcal{V}\interp{W}{((\text{\tiny{O}},g),b,e,a)} \triangleq&~\top
 \\
 		\left.
		\begin{IEEEeqnarraybox}[\IEEEeqnarraystrutmode \IEEEeqnarraystrutsizeadd{2pt}{2pt}][c]{rCl} 
			\mathcal{V}\interp{W}{((\text{\tiny{RO}},g),b,e,a)} \\
			\mathcal{V}\interp{W}{((\text{\tiny{RW}},g),b,e,a)} \\
			\mathcal{V}\interp{W}{((\text{\tiny{RWL}},g),b,e,a)}
  \end{IEEEeqnarraybox}
  \, \right\}  &\triangleq  \left.\exists~p', p \sqsubseteq p' * \textsf{read\_write\_cond}(\textsf{p',b,e})
  \right. &\textit{where p is {\tiny{RO}}, {\tiny{RW}}, {\tiny{RWL}} resp.}
  \\
   		\left.
		\begin{IEEEeqnarraybox}[\IEEEeqnarraystrutmode \IEEEeqnarraystrutsizeadd{2pt}{2pt}][c]{rCl} 
			\mathcal{V}\interp{W}{((\text{\tiny{RX}},g),b,e,a)} \\
			\mathcal{V}\interp{W}{((\text{\tiny{RWX}},g),b,e,a)} \\
			\mathcal{V}\interp{W}{((\text{\tiny{RWLX}},g),b,e,a)}
  \end{IEEEeqnarraybox}
  \, \right\}  &\triangleq  \left.
	\begin{IEEEeqnarraybox}[
    \IEEEeqnarraystrutmode][c]{rCl}
    \exists~p', p \sqsubseteq p' &*& \textsf{read\_write\_cond}(\textsf{p',b,e})\\
  &*& ~\square~\textsf{exec\_cond(W)(\textsf{p,g,b,e})}
  \end{IEEEeqnarraybox}  
  \right. &\textit{where p is {\tiny{RX}}, {\tiny{RWX}}, {\tiny{RWLX}} resp.}
  \\
 		\mathcal{V}\interp{W}{((\text{\tiny{E}},g),b,e,a)} \triangleq&~\square~\textsf{enter\_cond}(W)(\textsf{g,b,e,a})
	\end{align*}
	\end{minipage}
	\label{fig:relation}
	\caption{Logical Relation for Words}
\end{figure*}


\begin{figure*}[ht]
	\begin{minipage}{\textwidth}
	\begin{align*}
 		\textsf{read\_write\_cond}(p,b,e) \triangleq&~\bigsep_{a \in [b,e]} \text{rel}(a,p,\mathcal{V})\\
 		\textsf{exec\_cond(W)(p,g,b,e)} \triangleq&~\forall a \in [b~e], W' \sqsubseteq^g W.~\rhd~\mathcal{E}\interp{W'}{((p,g),b,e,a)}\\
 		\textsf{enter\_cond(W)(g,b,e,a)} \triangleq&~\forall W' \sqsubseteq^g W.~\rhd~\mathcal{E}\interp{W}{((\textsf{\tiny{RX}},g),b,e,a)}
	\end{align*}
	\end{minipage}
	\\[2em]
	where $W' \sqsubseteq^{\tiny Global} W \iff W' \sqsubseteq_{priv} W$\\ and 
	$W' \sqsubseteq^{\tiny Local} W \iff W' \sqsubseteq_{pub} W$	
	
	\label{fig:condition}
	\caption{Capability Conditions}
\end{figure*}

\subsection{Definition of the Logical Relation}
The logical relation is a unary relation that relates a word to  \textit{capability safety}. Figure \ref{fig:relation}) describes the Iris implementation of the logical relation defined by Skorstensgaard et. al. \cite{skorstengaardESOP18}, in which the authors define a capability machine with Local capabilities, which imposes certain restrictions on where to store such capabilities. The value relation $\mathcal{V}$ is an Iris relation of type $World \to Word \to iProp$, where the World is a collection of state transition systems used to reason about local state, and a Word can be an integer of a capability. We then define the register relation $\mathcal{R}$ as the validity of each word that the register state maps to. 

The expression relation should capture what it means for programs to be capability safe. However, as previously discussed, programs in a machine lie in memory, pointed to by the program counter. Strictly speaking, there are no "expressions" in such a machine language. Instead, the expression relation relates Words to the notion of program capability safety, where the word in question will be the program counter state.

\subsection{The Context}
In the expression relation, the \textsf{context} contains the ghost resources necessary to run a program pointed to by the program counter. When the program has finished running, ownership of these resources is given back. To start out, the running program gets full ownership of all machine registers. A ghost register will be represented by the full ownership of the map from RegName to Word. We write 
$$ r \mapsto_r w$$
to indicate that registers r currently contains the word w. The context will contain such a statement for each register in the register map. 

A program may also need the ghost resources for the pieces of memory it has authority over. However, we want to respect the principle of least privilege. A program should only be able to gain ownership over the ghost resources for memory pointed to by a capability. Say a register contains a capability A. Consider the following memory layout.

\begin{center}
\MemoryLayout{
    12/blue!30!/A,
    21/blue!30!/B\relax
  }
\end{center}

In that case, the program may have authority over the region given by A, as well as the region given by B. However if no other capabilities are given, the program should not be given access to the ghost resources denoted by the white regions. 

One way to enforce this, is to define the value relation of a capability as an invariant containing the resources for its range of authority, which at the same time guarantees that all the words that these words point to are also valid. However, as the name indicates, an invariant can never change. This is not a problem when the only variant is the current state of a location. In this case however, the value relation is indexed over a particular \textit{World}. This World will capture the behaviour of local state. The validity of an executable capability will consider any possible future world. This becomes crucial when showing safety of programs that depend on well bracketed control flow. 

\subsection{The World}


%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.

  This research was supported in part by the ModuRes Sapere Aude
  Advanced Grant from The Danish Council for Independent Research
  for the Natural Sciences (FNU)
  and by XXX  
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


% Bibliography
\bibliography{reading_list}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
